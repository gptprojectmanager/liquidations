<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BTC Liquidation Heatmap - Coinglass Style</title>
    <script src="https://cdn.plot.ly/plotly-2.26.0.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #0d1117;
            color: #c9d1d9;
            min-height: 100vh;
        }
        .header {
            padding: 20px;
            background: #161b22;
            border-bottom: 1px solid #30363d;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .header h1 {
            font-size: 1.5rem;
            color: #f0b90b;
        }
        .controls {
            display: flex;
            gap: 10px;
        }
        .controls select, .controls button {
            padding: 8px 16px;
            background: #21262d;
            border: 1px solid #30363d;
            color: #c9d1d9;
            border-radius: 6px;
            cursor: pointer;
        }
        .controls select:hover, .controls button:hover {
            background: #30363d;
        }
        .controls button.primary {
            background: #238636;
            border-color: #238636;
        }
        .controls button.primary:hover {
            background: #2ea043;
        }
        #chart-container {
            padding: 20px;
            height: calc(100vh - 100px);
        }
        #heatmap {
            width: 100%;
            height: 100%;
        }
        .legend {
            position: fixed;
            top: 80px;
            right: 20px;
            background: rgba(22, 27, 34, 0.95);
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #30363d;
            font-size: 12px;
            z-index: 100;
        }
        .legend-item {
            display: flex;
            align-items: center;
            margin: 5px 0;
        }
        .legend-color {
            width: 20px;
            height: 12px;
            margin-right: 8px;
            border-radius: 2px;
        }
        .status {
            position: fixed;
            bottom: 20px;
            left: 20px;
            background: rgba(22, 27, 34, 0.95);
            padding: 10px 15px;
            border-radius: 6px;
            border: 1px solid #30363d;
            font-size: 12px;
        }
        .status.loading { border-color: #f0b90b; }
        .status.success { border-color: #238636; }
        .status.error { border-color: #da3633; }
    </style>
</head>
<body>
    <div class="header">
        <h1>BTC Liquidation Heatmap</h1>
        <div class="controls">
            <select id="timeframe">
                <option value="100">Last 100 candles</option>
                <option value="200" selected>Last 200 candles</option>
                <option value="500">Last 500 candles</option>
            </select>
            <select id="interval">
                <option value="5m">5 minute</option>
                <option value="15m" selected>15 minute</option>
            </select>
            <button class="primary" onclick="loadHeatmap()">Load Heatmap</button>
        </div>
    </div>

    <div class="legend">
        <div class="legend-item">
            <div class="legend-color" style="background: linear-gradient(to right, #1a1a2e, #f0b90b);"></div>
            <span>Liquidation Density</span>
        </div>
        <div class="legend-item">
            <div class="legend-color" style="background: #26a69a;"></div>
            <span>Price Up</span>
        </div>
        <div class="legend-item">
            <div class="legend-color" style="background: #ef5350;"></div>
            <span>Price Down</span>
        </div>
    </div>

    <div id="chart-container">
        <div id="heatmap"></div>
    </div>

    <div id="status" class="status">Ready - Click "Load Heatmap"</div>

    <script>
        const API_BASE = 'http://localhost:8888';

        function setStatus(message, type = '') {
            const status = document.getElementById('status');
            status.textContent = message;
            status.className = 'status ' + type;
        }

        async function loadHeatmap() {
            const limit = document.getElementById('timeframe').value;
            const interval = document.getElementById('interval').value;

            setStatus('Loading price data...', 'loading');

            try {
                // Fetch klines (price data)
                const klinesRes = await fetch(`${API_BASE}/prices/klines?symbol=BTCUSDT&interval=${interval}&limit=${limit}`);
                const klinesData = await klinesRes.json();

                if (!klinesData.data || klinesData.data.length === 0) {
                    setStatus('No price data available', 'error');
                    return;
                }

                setStatus('Loading liquidation levels...', 'loading');

                // Fetch liquidation levels with correct parameters
                const levelsRes = await fetch(`${API_BASE}/liquidations/levels?symbol=BTCUSDT&timeframe=30&model=openinterest`);
                const levelsData = await levelsRes.json();

                setStatus('Rendering heatmap...', 'loading');

                // Prepare data
                const timestamps = klinesData.data.map(k => k.timestamp);
                const opens = klinesData.data.map(k => k.open);
                const highs = klinesData.data.map(k => k.high);
                const lows = klinesData.data.map(k => k.low);
                const closes = klinesData.data.map(k => k.close);

                // Calculate price range for heatmap
                const minPrice = Math.min(...lows) * 0.95;
                const maxPrice = Math.max(...highs) * 1.05;
                // Guard against zero step (would cause infinite loop)
                const priceStep = Math.max((maxPrice - minPrice) / 100, 1);

                // Build price buckets
                const priceBuckets = [];
                for (let p = minPrice; p <= maxPrice; p += priceStep) {
                    priceBuckets.push(Math.round(p));
                }

                // Build heatmap matrix based on liquidation levels
                // Each cell shows liquidation density at that price level
                const heatmapZ = [];
                const longLiqs = levelsData.long_liquidations || [];
                const shortLiqs = levelsData.short_liquidations || [];

                // Normalize volumes for color intensity (log scale)
                const allVolumes = [...longLiqs, ...shortLiqs].map(l => parseFloat(l.volume));
                const maxVol = Math.max(...allVolumes, 1);

                for (const price of priceBuckets) {
                    const row = [];
                    for (let i = 0; i < timestamps.length; i++) {
                        // Calculate density based on distance from liquidation levels
                        let density = 0;

                        // Check long liquidations (below current price)
                        for (const liq of longLiqs) {
                            const liqPrice = parseFloat(liq.price_level);
                            const distance = Math.abs(price - liqPrice);
                            const maxDist = (maxPrice - minPrice) * 0.05; // 5% of price range
                            if (distance < maxDist) {
                                const vol = parseFloat(liq.volume || 1);
                                density += (1 - distance / maxDist) * Math.log10(vol + 1) / Math.log10(maxVol + 1);
                            }
                        }

                        // Check short liquidations (above current price)
                        for (const liq of shortLiqs) {
                            const liqPrice = parseFloat(liq.price_level);
                            const distance = Math.abs(price - liqPrice);
                            const maxDist = (maxPrice - minPrice) * 0.05;
                            if (distance < maxDist) {
                                const vol = parseFloat(liq.volume || 1);
                                density += (1 - distance / maxDist) * Math.log10(vol + 1) / Math.log10(maxVol + 1);
                            }
                        }

                        row.push(density);
                    }
                    heatmapZ.push(row);
                }

                // Create traces
                const traces = [];

                // 1. Heatmap trace (background)
                traces.push({
                    z: heatmapZ,
                    x: timestamps,
                    y: priceBuckets,
                    type: 'heatmap',
                    colorscale: [
                        [0, 'rgba(26, 26, 46, 0.8)'],
                        [0.2, 'rgba(75, 0, 130, 0.7)'],
                        [0.4, 'rgba(138, 43, 226, 0.7)'],
                        [0.6, 'rgba(0, 191, 255, 0.7)'],
                        [0.8, 'rgba(0, 255, 127, 0.7)'],
                        [1, 'rgba(240, 185, 11, 0.9)']
                    ],
                    showscale: true,
                    colorbar: {
                        title: 'Liquidation<br>Density',
                        titleside: 'right',
                        thickness: 15,
                        len: 0.5,
                        y: 0.75
                    },
                    hovertemplate: 'Time: %{x}<br>Price: $%{y:,.0f}<br>Density: %{z:.2f}<extra></extra>'
                });

                // 2. Candlestick trace (overlay)
                traces.push({
                    x: timestamps,
                    open: opens,
                    high: highs,
                    low: lows,
                    close: closes,
                    type: 'candlestick',
                    increasing: { line: { color: '#26a69a' }, fillcolor: '#26a69a' },
                    decreasing: { line: { color: '#ef5350' }, fillcolor: '#ef5350' },
                    name: 'BTC/USDT',
                    hoverinfo: 'x+y'
                });

                // 3. Add liquidation level markers
                const currentPrice = closes[closes.length - 1];

                // Long liquidation zones (red, below price)
                for (const liq of longLiqs.slice(0, 5)) {
                    traces.push({
                        x: [timestamps[0], timestamps[timestamps.length - 1]],
                        y: [parseFloat(liq.price_level), parseFloat(liq.price_level)],
                        mode: 'lines',
                        line: { color: 'rgba(239, 83, 80, 0.5)', width: 1, dash: 'dot' },
                        name: `Long Liq ${liq.leverage}`,
                        showlegend: false,
                        hovertemplate: `Long Liq ${liq.leverage}: $%{y:,.2f}<extra></extra>`
                    });
                }

                // Short liquidation zones (green, above price)
                for (const liq of shortLiqs.slice(0, 5)) {
                    traces.push({
                        x: [timestamps[0], timestamps[timestamps.length - 1]],
                        y: [parseFloat(liq.price_level), parseFloat(liq.price_level)],
                        mode: 'lines',
                        line: { color: 'rgba(38, 166, 154, 0.5)', width: 1, dash: 'dot' },
                        name: `Short Liq ${liq.leverage}`,
                        showlegend: false,
                        hovertemplate: `Short Liq ${liq.leverage}: $%{y:,.2f}<extra></extra>`
                    });
                }

                // Layout
                const layout = {
                    title: {
                        text: `BTC/USDT Liquidation Heatmap (${interval})`,
                        font: { color: '#c9d1d9', size: 16 }
                    },
                    paper_bgcolor: '#0d1117',
                    plot_bgcolor: '#161b22',
                    font: { color: '#c9d1d9' },
                    xaxis: {
                        title: 'Time',
                        gridcolor: '#30363d',
                        rangeslider: { visible: false }
                    },
                    yaxis: {
                        title: 'Price (USDT)',
                        gridcolor: '#30363d',
                        tickformat: '$,.0f'
                    },
                    showlegend: false,
                    margin: { t: 50, b: 50, l: 80, r: 100 }
                };

                const config = {
                    responsive: true,
                    displayModeBar: true,
                    modeBarButtonsToRemove: ['lasso2d', 'select2d']
                };

                Plotly.newPlot('heatmap', traces, layout, config);

                const longCount = longLiqs.length;
                const shortCount = shortLiqs.length;
                setStatus(`Loaded: ${klinesData.count} candles, ${longCount} long / ${shortCount} short liquidation levels`, 'success');

            } catch (error) {
                console.error('Error:', error);
                setStatus(`Error: ${error.message}`, 'error');
            }
        }

        // Auto-load on page ready
        document.addEventListener('DOMContentLoaded', () => {
            setTimeout(loadHeatmap, 500);
        });
    </script>
</body>
</html>
