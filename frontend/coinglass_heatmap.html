<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BTC Liquidation Heatmap - Coinglass Style</title>
    <script src="https://cdn.plot.ly/plotly-2.26.0.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #0d1117;
            color: #c9d1d9;
            min-height: 100vh;
        }
        .header {
            padding: 20px;
            background: #161b22;
            border-bottom: 1px solid #30363d;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .header h1 {
            font-size: 1.5rem;
            color: #f0b90b;
        }
        .controls {
            display: flex;
            gap: 10px;
        }
        .controls select, .controls button {
            padding: 8px 16px;
            background: #21262d;
            border: 1px solid #30363d;
            color: #c9d1d9;
            border-radius: 6px;
            cursor: pointer;
        }
        .controls select:hover, .controls button:hover {
            background: #30363d;
        }
        .controls button.primary {
            background: #238636;
            border-color: #238636;
        }
        .controls button.primary:hover {
            background: #2ea043;
        }
        #chart-container {
            padding: 20px;
            height: calc(100vh - 100px);
        }
        #heatmap {
            width: 100%;
            height: 100%;
        }
        .legend {
            position: fixed;
            top: 80px;
            right: 20px;
            background: rgba(22, 27, 34, 0.95);
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #30363d;
            font-size: 12px;
            z-index: 100;
        }
        .legend-item {
            display: flex;
            align-items: center;
            margin: 5px 0;
        }
        .legend-color {
            width: 20px;
            height: 12px;
            margin-right: 8px;
            border-radius: 2px;
        }
        .status {
            position: fixed;
            bottom: 20px;
            left: 20px;
            background: rgba(22, 27, 34, 0.95);
            padding: 10px 15px;
            border-radius: 6px;
            border: 1px solid #30363d;
            font-size: 12px;
        }
        .status.loading { border-color: #f0b90b; }
        .status.success { border-color: #238636; }
        .status.error { border-color: #da3633; }
    </style>
</head>
<body>
    <div class="header">
        <h1>BTC Liquidation Heatmap</h1>
        <div class="controls">
            <select id="timeframe">
                <option value="100">Last 100 candles</option>
                <option value="200" selected>Last 200 candles</option>
                <option value="500">Last 500 candles</option>
            </select>
            <select id="interval">
                <option value="5m">5 minute</option>
                <option value="15m" selected>15 minute</option>
            </select>
            <button class="primary" onclick="loadHeatmap()">Load Heatmap</button>
        </div>
    </div>

    <div class="legend">
        <div class="legend-item">
            <div class="legend-color" style="background: linear-gradient(to right, #1a1a2e, #f0b90b);"></div>
            <span>Liquidation Density</span>
        </div>
        <div class="legend-item">
            <div class="legend-color" style="background: #26a69a;"></div>
            <span>Price Up</span>
        </div>
        <div class="legend-item">
            <div class="legend-color" style="background: #ef5350;"></div>
            <span>Price Down</span>
        </div>
        <div class="legend-item" id="consumed-indicator" style="display: none;">
            <div class="legend-color" style="background: rgba(100, 100, 100, 0.5);"></div>
            <span>Consumed (liquidated)</span>
        </div>
        <div class="legend-item" id="time-evolving-badge">
            <span style="color: #238636; font-weight: bold;">Time-Evolving Mode</span>
        </div>
    </div>

    <div id="chart-container">
        <div id="heatmap"></div>
    </div>

    <div id="status" class="status">Ready - Click "Load Heatmap"</div>

    <script>
        const API_BASE = 'http://localhost:8888';

        function setStatus(message, type = '') {
            const status = document.getElementById('status');
            status.textContent = message;
            status.className = 'status ' + type;
        }

        async function loadHeatmap() {
            const limit = document.getElementById('timeframe').value;
            const interval = document.getElementById('interval').value;

            setStatus('Loading time-evolving heatmap data...', 'loading');

            try {
                // Fetch time-evolving heatmap from new endpoint (T046)
                const heatmapRes = await fetch(
                    `${API_BASE}/liquidations/heatmap-timeseries?symbol=BTCUSDT&interval=${interval}&limit=${limit}`
                );

                if (!heatmapRes.ok) {
                    const errorData = await heatmapRes.json().catch(() => ({}));
                    throw new Error(errorData.detail || `HTTP ${heatmapRes.status}`);
                }

                const heatmapData = await heatmapRes.json();

                if (!heatmapData.data || heatmapData.data.length === 0) {
                    setStatus('No heatmap data available', 'error');
                    return;
                }

                setStatus('Loading price data...', 'loading');

                // Fetch klines for candlestick overlay
                const klinesRes = await fetch(
                    `${API_BASE}/prices/klines?symbol=BTCUSDT&interval=${interval}&limit=${limit}`
                );
                const klinesData = await klinesRes.json();

                setStatus('Rendering time-evolving heatmap...', 'loading');

                // Transform time-series data to 2D heatmap matrix (T047)
                const snapshots = heatmapData.data;
                const meta = heatmapData.meta;

                // Extract all unique timestamps and price levels
                const timestamps = snapshots.map(s => s.timestamp);

                // Build unified price bucket list from API price range
                const minPrice = meta.price_range.min || 90000;
                const maxPrice = meta.price_range.max || 100000;
                const priceStep = 100; // $100 buckets as defined in algorithm

                const priceBuckets = [];
                for (let p = Math.floor(minPrice / priceStep) * priceStep;
                     p <= Math.ceil(maxPrice / priceStep) * priceStep;
                     p += priceStep) {
                    priceBuckets.push(p);
                }

                // Build heatmap matrix: Z[priceIdx][timeIdx] = density (T048)
                // CRITICAL: Each column now has DIFFERENT density based on that timestamp's state
                const heatmapZ = [];
                let maxDensity = 0;
                let totalConsumed = 0;

                for (const price of priceBuckets) {
                    const row = [];
                    for (let timeIdx = 0; timeIdx < snapshots.length; timeIdx++) {
                        const snapshot = snapshots[timeIdx];
                        totalConsumed += snapshot.positions_consumed;

                        // Find density at this price for this timestamp
                        let density = 0;
                        for (const level of snapshot.levels) {
                            // Match price bucket (within tolerance)
                            if (Math.abs(level.price - price) < priceStep / 2) {
                                density = level.long_density + level.short_density;
                                break;
                            }
                        }

                        // Apply log scale for better visualization
                        const logDensity = density > 0 ? Math.log10(density + 1) : 0;
                        row.push(logDensity);
                        maxDensity = Math.max(maxDensity, logDensity);
                    }
                    heatmapZ.push(row);
                }

                // Normalize to 0-1 range for colorscale
                if (maxDensity > 0) {
                    for (let i = 0; i < heatmapZ.length; i++) {
                        for (let j = 0; j < heatmapZ[i].length; j++) {
                            heatmapZ[i][j] = heatmapZ[i][j] / maxDensity;
                        }
                    }
                }

                // Create traces
                const traces = [];

                // 1. Time-evolving heatmap trace (T048 - per-column density)
                traces.push({
                    z: heatmapZ,
                    x: timestamps,
                    y: priceBuckets,
                    type: 'heatmap',
                    colorscale: [
                        [0, 'rgba(26, 26, 46, 0.9)'],      // Empty - dark
                        [0.15, 'rgba(75, 0, 130, 0.8)'],   // Low - purple
                        [0.3, 'rgba(138, 43, 226, 0.8)'],  // Medium-low - violet
                        [0.5, 'rgba(0, 191, 255, 0.8)'],   // Medium - cyan
                        [0.7, 'rgba(0, 255, 127, 0.8)'],   // Medium-high - green
                        [0.85, 'rgba(255, 165, 0, 0.9)'],  // High - orange
                        [1, 'rgba(240, 185, 11, 1)']       // Maximum - gold
                    ],
                    showscale: true,
                    colorbar: {
                        title: 'Liquidation<br>Density',
                        titleside: 'right',
                        thickness: 15,
                        len: 0.5,
                        y: 0.75
                    },
                    hovertemplate: 'Time: %{x}<br>Price: $%{y:,.0f}<br>Density: %{z:.3f}<extra></extra>'
                });

                // 2. Candlestick overlay (if klines available)
                if (klinesData.data && klinesData.data.length > 0) {
                    const klines = klinesData.data;
                    traces.push({
                        x: klines.map(k => k.timestamp),
                        open: klines.map(k => k.open),
                        high: klines.map(k => k.high),
                        low: klines.map(k => k.low),
                        close: klines.map(k => k.close),
                        type: 'candlestick',
                        increasing: { line: { color: '#26a69a' }, fillcolor: '#26a69a' },
                        decreasing: { line: { color: '#ef5350' }, fillcolor: '#ef5350' },
                        name: 'BTC/USDT',
                        hoverinfo: 'x+y'
                    });
                }

                // Layout with timestamp labels (T050)
                const layout = {
                    title: {
                        text: `BTC/USDT Time-Evolving Liquidation Heatmap (${interval})`,
                        font: { color: '#c9d1d9', size: 16 }
                    },
                    paper_bgcolor: '#0d1117',
                    plot_bgcolor: '#161b22',
                    font: { color: '#c9d1d9' },
                    xaxis: {
                        title: 'Time (Each column = snapshot state)',
                        gridcolor: '#30363d',
                        rangeslider: { visible: false },
                        tickformat: '%H:%M<br>%m/%d'
                    },
                    yaxis: {
                        title: 'Price (USDT)',
                        gridcolor: '#30363d',
                        tickformat: '$,.0f'
                    },
                    showlegend: false,
                    margin: { t: 50, b: 70, l: 80, r: 100 },
                    annotations: totalConsumed > 0 ? [{
                        x: 0.02,
                        y: 0.98,
                        xref: 'paper',
                        yref: 'paper',
                        text: `Consumed: ${totalConsumed} positions`,
                        showarrow: false,
                        font: { color: '#f0b90b', size: 12 },
                        bgcolor: 'rgba(22, 27, 34, 0.9)',
                        borderpad: 4
                    }] : []
                };

                const config = {
                    responsive: true,
                    displayModeBar: true,
                    modeBarButtonsToRemove: ['lasso2d', 'select2d']
                };

                Plotly.newPlot('heatmap', traces, layout, config);

                // Show consumed indicator if any liquidations occurred (T049)
                if (totalConsumed > 0) {
                    document.getElementById('consumed-indicator').style.display = 'flex';
                }

                // Status message with metadata
                const snapshotCount = snapshots.length;
                const priceRange = `$${meta.price_range.min?.toLocaleString() || '?'} - $${meta.price_range.max?.toLocaleString() || '?'}`;
                setStatus(
                    `Time-evolving: ${snapshotCount} snapshots | ${priceRange} | ` +
                    `Long: ${meta.total_long_volume?.toFixed(2) || 0} | Short: ${meta.total_short_volume?.toFixed(2) || 0} | ` +
                    `Consumed: ${totalConsumed}`,
                    'success'
                );

            } catch (error) {
                console.error('Error loading heatmap:', error);
                setStatus(`Error: ${error.message}`, 'error');
            }
        }

        // Auto-load on page ready
        document.addEventListener('DOMContentLoaded', () => {
            setTimeout(loadHeatmap, 500);
        });
    </script>
</body>
</html>
