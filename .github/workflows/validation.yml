# Model Validation Pipeline
#
# Runs automated validation of liquidation prediction model.
# Per specs/014-validation-pipeline/contracts/ci_workflow.yml
#
# Triggers:
# - Weekly schedule (Monday 6am UTC)
# - Manual dispatch via GitHub UI
# - Push to main/master on model changes

name: Model Validation Pipeline

on:
  # Weekly scheduled run
  schedule:
    - cron: '0 6 * * 1'  # Monday 6:00 AM UTC

  # Manual trigger via GitHub UI
  workflow_dispatch:
    inputs:
      symbol:
        description: 'Trading symbol to validate'
        required: true
        default: 'BTCUSDT'
        type: string
      validation_types:
        description: 'Validation types to run (comma-separated)'
        required: false
        default: 'backtest'
        type: string
      tolerance_pct:
        description: 'Price tolerance percentage for backtest'
        required: false
        default: '2.0'
        type: string

  # Trigger on model changes
  push:
    paths:
      - 'src/liquidationheatmap/models/**'
      - 'src/liquidationheatmap/validation/**'
    branches:
      - master
      - main

env:
  PYTHON_VERSION: '3.11'
  DUCKDB_PATH: 'data/processed/liquidations.duckdb'

jobs:
  validation:
    name: Run Validation Pipeline
    runs-on: self-hosted  # Requires database access
    timeout-minutes: 30

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install UV
        run: curl -LsSf https://astral.sh/uv/install.sh | sh

      - name: Install dependencies
        run: |
          export PATH="$HOME/.local/bin:$PATH"
          uv sync

      - name: Check database exists
        id: db_check
        run: |
          if [ -f "${{ env.DUCKDB_PATH }}" ]; then
            echo "db_exists=true" >> $GITHUB_OUTPUT
            echo "âœ… Database found: ${{ env.DUCKDB_PATH }}"
          else
            echo "db_exists=false" >> $GITHUB_OUTPUT
            echo "::warning::Database not found at ${{ env.DUCKDB_PATH }}"
          fi

      - name: Run validation pipeline
        if: steps.db_check.outputs.db_exists == 'true'
        id: validation
        run: |
          export PATH="$HOME/.local/bin:$PATH"

          uv run python scripts/run_validation_pipeline.py \
            --symbol ${{ github.event.inputs.symbol || 'BTCUSDT' }} \
            --validation-types ${{ github.event.inputs.validation_types || 'backtest' }} \
            --tolerance-pct ${{ github.event.inputs.tolerance_pct || '2.0' }} \
            --output reports/validation_ci_result.json \
            --verbose

          # Extract metrics for summary
          if [ -f reports/validation_ci_result.json ]; then
            F1=$(jq -r '.results[0].overall_score // 0' reports/validation_ci_result.json)
            GRADE=$(jq -r '.results[0].overall_grade // "N/A"' reports/validation_ci_result.json)
            GATE=$(jq -r '.results[0].gate_2_decision // "skip"' reports/validation_ci_result.json)

            echo "f1_score=$F1" >> $GITHUB_OUTPUT
            echo "grade=$GRADE" >> $GITHUB_OUTPUT
            echo "gate_decision=$GATE" >> $GITHUB_OUTPUT
          fi

      - name: Gate 2 Check
        if: steps.db_check.outputs.db_exists == 'true'
        run: |
          GATE="${{ steps.validation.outputs.gate_decision }}"
          F1="${{ steps.validation.outputs.f1_score }}"
          GRADE="${{ steps.validation.outputs.grade }}"

          echo "## Validation Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "$GATE" == "pass" ]; then
            echo "### âœ… Gate 2 PASSED" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Model validated - F1 >= 60%" >> $GITHUB_STEP_SUMMARY
          elif [ "$GATE" == "acceptable" ]; then
            echo "### âš ï¸ Gate 2 ACCEPTABLE" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Model has limitations - document and proceed with caution" >> $GITHUB_STEP_SUMMARY
          else
            echo "### âŒ Gate 2 FAILED" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Model rework required - F1 < 40%" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Metric | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| F1 Score | ${F1}% |" >> $GITHUB_STEP_SUMMARY
          echo "| Grade | $GRADE |" >> $GITHUB_STEP_SUMMARY
          echo "| Gate Decision | $GATE |" >> $GITHUB_STEP_SUMMARY

          # Fail workflow if gate failed
          if [ "$GATE" == "fail" ]; then
            echo "::error::Gate 2 FAILED - Model rework required"
            exit 1
          fi

      - name: Upload validation report
        if: always() && steps.db_check.outputs.db_exists == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: validation-report-${{ github.run_id }}
          path: |
            reports/validation_ci_result.json
            reports/backtest_*.md
            reports/backtest_*.json
          retention-days: 30

      - name: Post summary
        if: always()
        run: |
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Run ID**: \`${{ github.run_id }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Symbol**: \`${{ github.event.inputs.symbol || 'BTCUSDT' }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Trigger**: \`${{ github.event_name }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Timestamp**: \`$(date -u +%Y-%m-%dT%H:%M:%SZ)\`" >> $GITHUB_STEP_SUMMARY

  notify:
    name: Notify on Failure
    needs: validation
    if: failure()
    runs-on: ubuntu-latest

    steps:
      - name: Create issue on failure
        uses: actions/github-script@v7
        with:
          script: |
            const date = new Date().toISOString().split('T')[0];
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `ðŸš¨ Validation Pipeline Failed - ${date}`,
              body: `## Validation Pipeline Failure

**Run ID**: ${context.runId}
**Trigger**: ${context.eventName}
**Symbol**: ${{ github.event.inputs.symbol || 'BTCUSDT' }}

### Details

The validation pipeline failed. This could indicate:
- Model accuracy has degraded below acceptable thresholds
- Database connectivity issues
- Configuration problems

### Action Required

1. Review the [workflow run](${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId})
2. Check validation reports in artifacts
3. Investigate root cause and fix

---
*This issue was automatically created by the validation pipeline.*`,
              labels: ['validation', 'automated', 'bug']
            });
