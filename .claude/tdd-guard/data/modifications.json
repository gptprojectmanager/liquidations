{
  "session_id": "10c0e675-c172-4652-91b7-32a860e8b4cf",
  "transcript_path": "/home/sam/.claude/projects/-media-sam-1TB-LiquidationHeatmap/10c0e675-c172-4652-91b7-32a860e8b4cf.jsonl",
  "hook_event_name": "PreToolUse",
  "tool_name": "Write",
  "tool_input": {
    "file_path": "/media/sam/1TB/LiquidationHeatmap/src/liquidationheatmap/api/_history_endpoint.py",
    "content": "\"\"\"Historical liquidations endpoint implementation (T047).\"\"\"\n\nfrom typing import Optional\nfrom fastapi import Query\nfrom ..ingestion.db_service import DuckDBService\n\n\nasync def get_liquidation_history(\n    symbol: str = Query(\"BTCUSDT\", description=\"Trading pair symbol\"),\n    start: Optional[str] = Query(None, description=\"Start datetime (ISO format)\"),\n    end: Optional[str] = Query(None, description=\"End datetime (ISO format)\"),\n    aggregate: bool = Query(False, description=\"Aggregate by timestamp and side\"),\n):\n    \"\"\"Get historical liquidation data from database.\n\n    Query actual liquidation events stored in liquidation_history table.\n    Supports date filtering and aggregation for time-series analysis.\n\n    Args:\n        symbol: Trading pair (e.g., BTCUSDT)\n        start: Optional start datetime filter\n        end: Optional end datetime filter\n        aggregate: If true, group by timestamp and side with totals\n\n    Returns:\n        List of historical liquidation records or aggregated data\n    \"\"\"\n    db = DuckDBService()\n\n    try:\n        if aggregate:\n            # Aggregated query for time-series visualization\n            query = \"\"\"\n            SELECT\n                timestamp,\n                side,\n                SUM(quantity) as total_volume,\n                COUNT(*) as num_levels,\n                AVG(price) as avg_price\n            FROM liquidation_history\n            WHERE symbol = ?\n            \"\"\"\n\n            params = [symbol]\n\n            if start:\n                query += \" AND timestamp >= ?\"\n                params.append(start)\n\n            if end:\n                query += \" AND timestamp <= ?\"\n                params.append(end)\n\n            query += \" GROUP BY timestamp, side ORDER BY timestamp, side\"\n\n            df = db.conn.execute(query, params).df()\n\n            return [\n                {\n                    \"timestamp\": str(rec[\"timestamp\"]),\n                    \"side\": rec[\"side\"],\n                    \"total_volume\": float(rec[\"total_volume\"]),\n                    \"num_levels\": int(rec[\"num_levels\"]),\n                    \"avg_price\": float(rec[\"avg_price\"]),\n                }\n                for rec in df.to_dict(orient=\"records\")\n            ]\n\n        else:\n            # Raw historical records\n            query = \"\"\"\n            SELECT timestamp, symbol, price, quantity, side, leverage, model\n            FROM liquidation_history\n            WHERE symbol = ?\n            \"\"\"\n\n            params = [symbol]\n\n            if start:\n                query += \" AND timestamp >= ?\"\n                params.append(start)\n\n            if end:\n                query += \" AND timestamp <= ?\"\n                params.append(end)\n\n            query += \" ORDER BY timestamp DESC, side, leverage\"\n\n            df = db.conn.execute(query, params).df()\n\n            return [\n                {\n                    \"timestamp\": str(rec[\"timestamp\"]),\n                    \"symbol\": rec[\"symbol\"],\n                    \"price\": float(rec[\"price\"]),\n                    \"quantity\": float(rec[\"quantity\"]),\n                    \"side\": rec[\"side\"],\n                    \"leverage\": int(rec[\"leverage\"]),\n                    \"model\": rec[\"model\"],\n                }\n                for rec in df.to_dict(orient=\"records\")\n            ]\n\n    finally:\n        db.close()\n"
  }
}