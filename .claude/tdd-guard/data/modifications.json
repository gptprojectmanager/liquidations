{
  "session_id": "b2022a35-c524-4321-8325-5206c74ca66f",
  "transcript_path": "/home/sam/.claude/projects/-media-sam-1TB-LiquidationHeatmap/b2022a35-c524-4321-8325-5206c74ca66f.jsonl",
  "hook_event_name": "PreToolUse",
  "tool_name": "Edit",
  "tool_input": {
    "file_path": "/media/sam/1TB/LiquidationHeatmap/scripts/generate_heatmap_cache.py",
    "old_string": "    try:\n        # TODO: Implement heatmap cache generation logic\n        # 1. Query liquidation_levels table\n        # 2. Aggregate by time_bucket and price_bucket\n        # 3. Calculate density (SUM of volumes per bucket)\n        # 4. INSERT into heatmap_cache table\n\n        console.print(\"[yellow]‚ö†Ô∏è  Implementation pending (T028 foundation)[/yellow]\")\n        logger.info(\"Heatmap cache generation foundation created\")\n\n    except Exception as e:\n        console.print(f\"\\n[bold red]‚ùå Cache generation failed:[/bold red] {e}\")\n        logger.error(f\"Cache generation failed: {e}\", exc_info=True)\n        sys.exit(1)\n    finally:\n        conn.close()\n\n    console.print(\"\\n[bold green]‚úÖ Foundation ready[/bold green]\")\n    console.print(\"[yellow]‚ÑπÔ∏è  Next: Implement aggregation SQL (T028)[/yellow]\\n\")",
    "new_string": "    start_time = datetime.now()\n\n    try:\n        # Clear existing cache for symbol\n        console.print(f\"\\nüóëÔ∏è  [cyan]Clearing existing cache for {args.symbol}...[/cyan]\")\n        conn.execute(f\"DELETE FROM heatmap_cache WHERE symbol = '{args.symbol}'\")\n\n        # Map time bucket to DuckDB interval\n        time_interval_map = {\n            \"1h\": \"1 hour\",\n            \"4h\": \"4 hours\",\n            \"12h\": \"12 hours\",\n            \"1d\": \"1 day\"\n        }\n        interval = time_interval_map[args.time_bucket]\n\n        # Generate heatmap cache\n        console.print(f\"üìä [cyan]Aggregating liquidations into heatmap buckets...[/cyan]\")\n        logger.info(f\"Aggregating with price_bucket=${args.price_bucket}, time_bucket={interval}\")\n\n        sql = f\"\"\"\n        INSERT INTO heatmap_cache\n        SELECT\n            ROW_NUMBER() OVER () AS id,\n            time_bucket_gapfill(INTERVAL '{interval}', timestamp,\n                (SELECT MIN(timestamp) FROM liquidation_levels WHERE symbol = '{args.symbol}'),\n                (SELECT MAX(timestamp) FROM liquidation_levels WHERE symbol = '{args.symbol}')\n            ) AS time_bucket,\n            FLOOR(price_level / {args.price_bucket}) * {args.price_bucket} AS price_bucket,\n            '{args.symbol}' AS symbol,\n            model,\n            COALESCE(COUNT(*), 0) AS density,\n            COALESCE(SUM(liquidation_volume), 0) AS volume,\n            CURRENT_TIMESTAMP AS last_updated\n        FROM liquidation_levels\n        WHERE symbol = '{args.symbol}'\n        GROUP BY time_bucket, price_bucket, model\n        HAVING density > 0\n        ORDER BY time_bucket, price_bucket, model\n        \"\"\"\n\n        result = conn.execute(sql)\n        rows_inserted = conn.execute(\"SELECT COUNT(*) FROM heatmap_cache WHERE symbol = ?\", [args.symbol]).fetchone()[0]\n\n        # Calculate duration\n        duration = (datetime.now() - start_time).total_seconds()\n\n        console.print(f\"\\n[bold green]‚úÖ Heatmap cache generated successfully![/bold green]\")\n        console.print(f\"Rows inserted: [bold]{rows_inserted}[/bold]\")\n        console.print(f\"Duration: [bold]{duration:.2f}s[/bold]\\n\")\n\n        logger.info(f\"Generated {rows_inserted} heatmap cache rows in {duration:.2f}s\")\n\n    except Exception as e:\n        console.print(f\"\\n[bold red]‚ùå Cache generation failed:[/bold red] {e}\")\n        logger.error(f\"Cache generation failed: {e}\", exc_info=True)\n        sys.exit(1)\n    finally:\n        conn.close()"
  }
}