# TDD Guard + Pytest Test Generator Integration

## Workflow Division

### **Skill: pytest-test-generator** (Template Generation)
**Responsibility**: Generate boilerplate test code
**Token Cost**: ~500 tokens (progressive disclosure)

```python
# What it does:
1. Read module interface
2. Generate test template from template file
3. Fill in {{PLACEHOLDERS}}
4. Write tests/test_module.py
```

### **Subagent: tdd-guard** (TDD Enforcement)
**Responsibility**: Enforce RED-GREEN-REFACTOR discipline
**Token Cost**: ~5,000 tokens (full agent context)

```python
# What it does:
1. Validate tests exist before code
2. Run tests and verify they FAIL (RED)
3. Block code without tests
4. Verify coverage >80% (REFACTOR)
5. Enforce test quality standards
```

---

## Complete TDD Workflow

### **Step 1: Generate Test Template** (Skill)
```
User: "Implement zmq_listener"

Main Claude: "First, generate tests"
‚îú‚îÄ Skill: pytest-test-generator
‚îÇ   ‚îî‚îÄ Generates: tests/test_zmq_listener.py (template)
```

**Output**:
```python
# tests/test_zmq_listener.py (GENERATED BY SKILL)
import pytest
from live.backend.zmq_listener import ZMQListener

@pytest.fixture
async def zmq_listener():
    """Fixture for ZMQ listener"""
    listener = ZMQListener()
    yield listener
    await listener.close()

async def test_zmq_connection(zmq_listener):
    """Test ZMQ connects to Bitcoin Core"""
    assert await zmq_listener.connect() == True  # RED: Will fail

async def test_transaction_stream(zmq_listener):
    """Test receiving raw tx bytes"""
    async for tx_bytes in zmq_listener.stream():
        assert isinstance(tx_bytes, bytes)
        assert len(tx_bytes) > 0
        break  # RED: Will fail
```

**Token Cost**: ~500 tokens

---

### **Step 2: Validate RED Phase** (TDD Guard Subagent)
```
Main Claude: "Validate RED phase"
‚îú‚îÄ Subagent: tdd-guard
‚îÇ   ‚îú‚îÄ Run: uv run pytest tests/test_zmq_listener.py
‚îÇ   ‚îú‚îÄ Check: Tests FAIL (as expected)
‚îÇ   ‚îî‚îÄ Approve: ‚úÖ Proceed to implementation
```

**TDD Guard Output**:
```
üî¥ RED PHASE VALIDATED
Tests run: 2
Tests failed: 2 (expected)
Failure reasons:
  - test_zmq_connection: ModuleNotFoundError: No module named 'live.backend.zmq_listener'
  - test_transaction_stream: ModuleNotFoundError: No module named 'live.backend.zmq_listener'

‚úÖ Tests fail for correct reasons (module doesn't exist)
‚úÖ Proceed with implementation
```

**Token Cost**: ~1,200 tokens (validation logic)

---

### **Step 3: Implement Code** (Subagent: bitcoin-onchain-expert)
```
Main Claude: "Implement minimal code"
‚îú‚îÄ Subagent: bitcoin-onchain-expert
‚îÇ   ‚îî‚îÄ Creates: live/backend/zmq_listener.py (minimal implementation)
```

**Token Cost**: ~8,000 tokens (full implementation)

---

### **Step 4: Validate GREEN Phase** (TDD Guard)
```
Main Claude: "Validate GREEN phase"
‚îú‚îÄ Subagent: tdd-guard
‚îÇ   ‚îú‚îÄ Run: uv run pytest tests/test_zmq_listener.py
‚îÇ   ‚îú‚îÄ Check: Tests PASS
‚îÇ   ‚îî‚îÄ Approve: ‚úÖ Proceed to refactor
```

**TDD Guard Output**:
```
üü¢ GREEN PHASE VALIDATED
Tests run: 2
Tests passed: 2
Coverage: 67%

‚ö†Ô∏è Coverage below 80%
‚ùå BLOCKED: Add missing tests before proceeding
```

**Token Cost**: ~1,500 tokens (coverage analysis)

---

### **Step 5: Add Missing Tests** (Skill + Developer)
```
Developer: "Add test for reconnection logic"
‚îú‚îÄ Skill: pytest-test-generator (generates template)
‚îÇ   ‚îî‚îÄ Adds: test_zmq_reconnection_on_failure()
```

**Generated Test**:
```python
async def test_zmq_reconnection_on_failure(zmq_listener):
    """Test ZMQ reconnects on connection loss"""
    # Simulate connection loss
    await zmq_listener.disconnect()
    # Should reconnect automatically
    assert await zmq_listener.connect() == True
```

**Token Cost**: ~300 tokens (incremental generation)

---

### **Step 6: Validate REFACTOR Phase** (TDD Guard)
```
Main Claude: "Validate coverage"
‚îú‚îÄ Subagent: tdd-guard
‚îÇ   ‚îú‚îÄ Run: uv run pytest --cov=live/backend --cov-report=term-missing
‚îÇ   ‚îú‚îÄ Check: Coverage >80%
‚îÇ   ‚îî‚îÄ Approve: ‚úÖ REFACTOR phase complete
```

**TDD Guard Output**:
```
‚ôªÔ∏è REFACTOR PHASE VALIDATED
Tests run: 3
Tests passed: 3
Coverage: 87%

‚úÖ Coverage above threshold (80%)
‚úÖ All tests passing
‚úÖ Ready for commit
```

**Token Cost**: ~800 tokens

---

## Token Savings Comparison

### **Without Skills** (Subagent Only)
```
Total token cost:
- Generate tests manually: ~3,000 tokens (reasoning + code)
- RED validation: ~1,200 tokens
- Implementation: ~8,000 tokens
- GREEN validation: ~1,500 tokens
- Add tests: ~2,000 tokens (reasoning + code)
- REFACTOR validation: ~800 tokens

TOTAL: ~16,500 tokens
```

### **With Skills** (Hybrid)
```
Total token cost:
- Generate tests (SKILL): ~500 tokens ‚úÖ (6x reduction)
- RED validation: ~1,200 tokens
- Implementation: ~8,000 tokens
- GREEN validation: ~1,500 tokens
- Add tests (SKILL): ~300 tokens ‚úÖ (6.6x reduction)
- REFACTOR validation: ~800 tokens

TOTAL: ~12,300 tokens (25% reduction)
```

**Savings**: ~4,200 tokens per module (25% reduction)

---

## Skill vs Subagent Breakdown

| Task | Tool | Reason | Tokens |
|------|------|--------|--------|
| Generate test boilerplate | **Skill** | Template-driven, no reasoning | ~500 |
| Validate RED phase | **Subagent** | Needs error analysis | ~1,200 |
| Implement module | **Subagent** | Complex reasoning | ~8,000 |
| Validate GREEN phase | **Subagent** | Coverage analysis | ~1,500 |
| Add missing tests | **Skill** | Template-driven | ~300 |
| Validate REFACTOR | **Subagent** | Quality checks | ~800 |

**Total Skill tokens**: 800 (~6% of workflow)
**Total Subagent tokens**: 11,500 (~94% of workflow)

**Key Insight**: Skills handle the "boring" template generation (6% effort, 25% token savings), while Subagents handle the "thinking" (94% effort, high value).

---

## Updated Modus Operandi

```yaml
TDD Workflow with Skills:

1. User Request:
   "Implement Task XX: Module Name"

2. Main Claude Orchestration:
   a) Skill: pytest-test-generator
      ‚Üí Generate: tests/test_module.py (RED phase ready)

   b) Subagent: tdd-guard
      ‚Üí Validate: Tests fail correctly (RED)

   c) Subagent: [task-specific-agent]
      ‚Üí Implement: live/backend/module.py (GREEN)

   d) Subagent: tdd-guard
      ‚Üí Validate: Tests pass (GREEN)

   e) If coverage <80%:
      - Skill: pytest-test-generator (add missing tests)
      - Goto step (d)

   f) Subagent: tdd-guard
      ‚Üí Validate: Coverage >80% (REFACTOR)

   g) Commit
```

---

## Configuration Update

Add to `.claude/prompts/utxoracle-system.md`:

```markdown
## TDD Workflow with Skills

### Before Implementation:
1. **Skill**: pytest-test-generator (generate test template)
2. **Subagent**: tdd-guard (validate RED phase)

### During Implementation:
3. **Subagent**: [task-agent] (implement module)
4. **Subagent**: tdd-guard (validate GREEN phase)

### After Implementation:
5. **Skill**: pytest-test-generator (add missing tests if needed)
6. **Subagent**: tdd-guard (validate REFACTOR phase)
```

---

## Example: Task 01 Complete Workflow

```bash
# Step 1: Generate tests (SKILL)
User: "Implement Task 01: ZMQ Listener"
Skill: pytest-test-generator ‚Üí tests/test_zmq_listener.py

# Step 2: Validate RED (SUBAGENT)
Subagent: tdd-guard
$ uv run pytest tests/test_zmq_listener.py -v
2 failed ‚úÖ (ModuleNotFoundError - expected)

# Step 3: Implement (SUBAGENT)
Subagent: bitcoin-onchain-expert ‚Üí live/backend/zmq_listener.py

# Step 4: Validate GREEN (SUBAGENT)
Subagent: tdd-guard
$ uv run pytest tests/test_zmq_listener.py -v
2 passed ‚úÖ
Coverage: 67% ‚ùå

# Step 5: Add tests (SKILL)
User: "Add test for error handling"
Skill: pytest-test-generator ‚Üí test_zmq_error_handling()

# Step 6: Validate REFACTOR (SUBAGENT)
Subagent: tdd-guard
$ uv run pytest --cov=live/backend/zmq_listener --cov-report=term
Coverage: 87% ‚úÖ

# Step 7: Commit
‚úÖ Task 01 complete with 87% coverage
```

**Total tokens**: ~12,300 (vs ~16,500 without Skills)

---

## Recommendation

**Use Skills for**:
- ‚úÖ Initial test template generation (boilerplate)
- ‚úÖ Adding incremental tests (template expansion)
- ‚úÖ Test file structure creation

**Use TDD Guard Subagent for**:
- ‚úÖ RED-GREEN-REFACTOR validation
- ‚úÖ Coverage analysis and enforcement
- ‚úÖ Test quality reasoning
- ‚úÖ Blocking code without tests

**Best of Both Worlds**:
- Skills reduce token waste on repetitive templates
- TDD Guard ensures discipline and quality
- Together: 25% token savings + 100% TDD compliance
