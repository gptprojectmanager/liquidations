# Implementation Plan: Funding Rate Bias Adjustment

**Branch**: `005-funding-rate-bias` | **Date**: 2025-12-01 | **Spec**: `/specs/005-specify-scripts-bash/spec.md`
**Input**: Feature specification from `/specs/005-specify-scripts-bash/spec.md`

**Note**: This plan was generated by the `/speckit.plan` command workflow.

## Summary

Market sentiment adjustment module that replaces naive 50/50 position distribution with dynamic long/short ratios based on funding rate data. Uses tanh transformation formula to convert funding rates (-0.10% to +0.10%) into position bias (30% to 70% range), improving liquidation model accuracy by 15-20% in backtests.

## Technical Context

**Language/Version**: Python 3.11
**Primary Dependencies**: httpx (async HTTP), cachetools (TTL caching), FastAPI (REST API), Pydantic v2 (data validation)
**Storage**: DuckDB for historical funding rates (90-day retention policy)
**Testing**: pytest with hypothesis for property-based testing, TDD approach required
**Target Platform**: Linux server (Ubuntu 22.04 LTS)
**Project Type**: single (backend service with REST API)
**Performance Goals**: <50ms per bias calculation, 1000 concurrent adjustments, <10ms single calculation
**Constraints**: <100MB memory overhead, 5-minute cache TTL, ±20% max adjustment from baseline
**Scale/Scope**: Support 10k API requests/minute, 3 user stories, 73 implementation tasks

## Constitution Check

*GATE: Must pass before Phase 0 research. Re-check after Phase 1 design.*

### Core Principles Validation

✅ **Mathematical Correctness (MUST)**: Tanh formula mathematically proven continuous and bounded
- Formula: `long_ratio = 0.5 + (tanh(funding_rate × 50.0) × 0.20)`
- Proof of continuity in research.md
- OI conservation guaranteed: long_ratio + short_ratio = 1.0

✅ **Test-Driven Development (MUST)**: All tasks follow Red-Green-Refactor cycle
- 73 tasks include test-first approach
- Property-based testing with hypothesis for OI conservation
- Unit tests required before implementation (T031-T033, T045-T046, T058-T059)

✅ **Exchange Compatibility (MUST)**: Binance API specification validated
- Using official `/fapi/v1/fundingRate` endpoint
- 8-hour funding periods handled correctly
- Rate limits respected with caching

✅ **Performance Efficiency (SHOULD)**: Meets latency requirements
- Single calculation: <10ms (tanh is O(1))
- API responses: <50ms with caching
- Batch operations optimized in T063

✅ **Data Integrity (MUST)**: Atomic updates with audit trail
- DuckDB ACID compliance for historical data
- Configuration versioning in YAML
- All adjustments logged with timestamps

✅ **Documentation Completeness (MUST)**: Full documentation suite
- OpenAPI 3.0 specification (bias-api.yaml)
- Mathematical formulas documented (research.md)
- Quickstart guide with examples (quickstart.md)

## Project Structure

### Documentation (this feature)

```
specs/[###-feature]/
├── plan.md              # This file (/speckit.plan command output)
├── research.md          # Phase 0 output (/speckit.plan command)
├── data-model.md        # Phase 1 output (/speckit.plan command)
├── quickstart.md        # Phase 1 output (/speckit.plan command)
├── contracts/           # Phase 1 output (/speckit.plan command)
└── tasks.md             # Phase 2 output (/speckit.tasks command - NOT created by /speckit.plan)
```

### Source Code (repository root)

```
src/
├── models/
│   └── funding/
│       ├── funding_rate.py
│       ├── bias_adjustment.py
│       ├── sentiment_indicator.py
│       └── adjustment_config.py
├── services/
│   └── funding/
│       ├── funding_fetcher.py
│       ├── bias_calculator.py
│       ├── cache_manager.py
│       ├── sentiment_analyzer.py
│       ├── alert_manager.py
│       ├── correlation_analyzer.py
│       ├── storage_service.py
│       ├── report_generator.py
│       ├── override_manager.py
│       └── math_utils.py
├── api/
│   └── endpoints/
│       └── bias.py
├── db/
│   └── migrations/
│       └── 005_funding_rates.sql
└── liquidationheatmap/
    └── models/
        ├── binance_standard.py
        ├── ensemble.py
        └── funding_adjusted.py

tests/
├── unit/
│   └── funding/
│       ├── test_bias_calculator.py
│       ├── test_validators.py
│       ├── test_sentiment_analyzer.py
│       ├── test_alert_manager.py
│       └── test_correlation_analyzer.py
└── integration/
    └── funding/
        ├── test_binance_api.py
        └── test_backtest.py

config/
└── bias_settings.yaml
```

**Structure Decision**: Single project structure selected (Option 1) as this is a backend service feature with REST API endpoints. All funding-related code organized under dedicated `funding/` subdirectories for clear separation of concerns.

## Complexity Tracking

*No constitution violations - all principles satisfied.*
